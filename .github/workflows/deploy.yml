name: deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to deploy (e.g., commit SHA)'
        required: true
        type: string
      environment:
        description: 'GitHub Environment to use (secrets/approvals)'
        required: true
        default: 'prod'
        type: choice
        options: [ 'prod' ]
      skip_migrate:
        description: 'Skip DB migration step'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: read

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ github.event.inputs.environment }}
    env:
      IMAGE_PREFIX: ghcr.io/${{ github.repository }}
      TAG: ${{ github.event.inputs.tag }}
      DOCKER_NETWORK: ${{ vars.DOCKER_NETWORK }}
      # For health checks (set these as Environment Variables)
      SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL }}
      API_BASE: ${{ vars.NEXT_PUBLIC_WEB_API_BASE }}
    steps:
      - name: Setup SSH known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          : "${SSH_PORT:=22}"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Write SSH key file
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          umask 077
          printf "%s" "$SSH_KEY" > "$RUNNER_TEMP/deploy_key"
          echo "SSH_KEY_FILE=$RUNNER_TEMP/deploy_key" >> "$GITHUB_ENV"
      - name: Verify inputs
        run: |
          test -n "$TAG" || { echo "tag is required"; exit 1; }

      - name: Prepare health endpoints
        id: health
        run: |
          site="$SITE_URL"; api="$API_BASE"
          site=${site%/}
          api=${api%/}
          echo "site_url=$site" >> $GITHUB_OUTPUT
          echo "api_health=$api/healthz" >> $GITHUB_OUTPUT

      - name: SSH deploy (pull → migrate → restart → health)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_ACTOR: ${{ github.actor }}
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
          TAG: ${{ env.TAG }}
          API_HEALTH: ${{ steps.health.outputs.api_health }}
          WEB_HEALTH: ${{ steps.health.outputs.site_url }}
          SKIP_MIGRATE: ${{ github.event.inputs.skip_migrate }}
          DOCKER_NETWORK: ${{ env.DOCKER_NETWORK }}
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          set -euo pipefail
          : "${SSH_PORT:=22}"
          GHCR_PAT=${GHCR_PAT:-}
          if [ -z "$GHCR_PAT" ]; then
            echo "[deploy] GHCR_PAT secret is required (GitHub Environment: ${DEPLOY_ENV})" >&2
            exit 1
          fi

          WEB_HEALTH_CLEAN="${WEB_HEALTH%/}/"

          printf -v IMAGE_PREFIX_ESC '%q' "$IMAGE_PREFIX"
          printf -v TAG_ESC '%q' "$TAG"
          printf -v GHCR_PAT_ESC '%q' "$GHCR_PAT"
          printf -v GITHUB_ACTOR_ESC '%q' "$GITHUB_ACTOR"
          printf -v API_HEALTH_ESC '%q' "$API_HEALTH"
          printf -v WEB_HEALTH_ESC '%q' "$WEB_HEALTH_CLEAN"
          printf -v SKIP_MIGRATE_ESC '%q' "$SKIP_MIGRATE"
          printf -v DOCKER_NETWORK_ESC '%q' "${DOCKER_NETWORK:-}"

          ssh -i "$SSH_KEY_FILE" -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            IMAGE_PREFIX=$IMAGE_PREFIX_ESC \
            TAG=$TAG_ESC \
            GHCR_PAT_INNER=$GHCR_PAT_ESC \
            GITHUB_ACTOR_INNER=$GITHUB_ACTOR_ESC \
            API_HEALTH=$API_HEALTH_ESC \
            WEB_HEALTH=$WEB_HEALTH_ESC \
            SKIP_MIGRATE=$SKIP_MIGRATE_ESC \
            DOCKER_NETWORK_INNER=$DOCKER_NETWORK_ESC \
            bash -s << 'EOF'
          set -euo pipefail

          echo "$GHCR_PAT_INNER" | docker login ghcr.io -u "$GITHUB_ACTOR_INNER" --password-stdin
          cd /srv/sogecon-app
          echo "[deploy] Pulling images..."
          docker pull "$IMAGE_PREFIX/alumni-api:$TAG"
          docker pull "$IMAGE_PREFIX/alumni-web:$TAG"

          if [ -n "$DOCKER_NETWORK_INNER" ]; then
            docker network inspect "$DOCKER_NETWORK_INNER" >/dev/null 2>&1 || docker network create "$DOCKER_NETWORK_INNER"
          fi

          if [ "$SKIP_MIGRATE" != "true" ]; then
            API_IMAGE="$IMAGE_PREFIX/alumni-api:$TAG" ENV_FILE=.env.api DOCKER_NETWORK="$DOCKER_NETWORK_INNER" \
              bash ./ops/cloud-migrate.sh
          else
            echo "[deploy] Skip migrate"
          fi

          API_IMAGE="$IMAGE_PREFIX/alumni-api:$TAG" \
          WEB_IMAGE="$IMAGE_PREFIX/alumni-web:$TAG" \
          DOCKER_NETWORK="$DOCKER_NETWORK_INNER" \
          API_ENV_FILE=.env.api WEB_ENV_FILE=.env.web \
          bash ./ops/cloud-start.sh

          echo "[deploy] Health checks"
          wait_200() {
            local name="$1"; local url="$2"; local timeout="${3:-60}"; local code="";
            if [ -z "$url" ]; then return 0; fi
            echo "[health] $name → $url"
            for i in $(seq 1 "$timeout"); do
              code=$(curl -sf -o /dev/null -w "%{http_code}" "$url" || true)
              if [ "$code" = "200" ]; then echo "[health] $name OK(200)"; return 0; fi
              sleep 1
            done
            echo "[health] $name failed; last code=$code" >&2; return 1
          }

          RC=0
          wait_200 api "$API_HEALTH" 90 || RC=1
          wait_200 web "$WEB_HEALTH" 90 || RC=1
          if [ $RC -ne 0 ]; then
            echo "[deploy] One or more health checks failed" >&2; exit 1
          fi
          echo "[deploy] OK"
          EOF

      - name: SSH cleanup images (always)
        if: always()
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
          TAG: ${{ env.TAG }}
          KEEP_IMAGES: ${{ vars.KEEP_IMAGES }}
        run: |
          set -euo pipefail
          : "${SSH_PORT:=22}"
          ssh -i "$SSH_KEY_FILE" -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash -s << 'EOF'
          set -euo pipefail
          KEEP="${KEEP_IMAGES:-8}"
          API_REPO="$IMAGE_PREFIX/alumni-api"
          WEB_REPO="$IMAGE_PREFIX/alumni-web"
          CURRENT_API=$(docker inspect -f '{{.Config.Image}}' alumni-api 2>/dev/null || true)
          CURRENT_WEB=$(docker inspect -f '{{.Config.Image}}' alumni-web 2>/dev/null || true)

          cleanup_repo() {
            local repo="$1"; local keep="$2"; shift 2 || true
            mapfile -t imgs < <(docker image ls "$repo" --format '{{.Repository}}:{{.Tag}}' | grep -v '<none>' || true)
            if [ "${#imgs[@]}" -le "$keep" ]; then return 0; fi
            for img in "${imgs[@]:$keep}"; do
              if [ "$img" = "$CURRENT_API" ] || [ "$img" = "$CURRENT_WEB" ]; then
                echo "[cleanup] skip in-use: $img"; continue
              fi
              echo "[cleanup] remove: $img"
              docker image rm -f "$img" || true
            done
          }

          echo "[cleanup] keep last $KEEP images per repo (excluding running)"
          cleanup_repo "$API_REPO" "$KEEP"
          cleanup_repo "$WEB_REPO" "$KEEP"

          # remove dangling layers older than one week
          docker image prune -af --filter until=168h || true
          EOF

      - name: Summary
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "Deployed to $DEPLOY_ENV" >> "$GITHUB_STEP_SUMMARY"
          echo "Tag: $TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "API: $IMAGE_PREFIX/alumni-api:$TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "WEB: $IMAGE_PREFIX/alumni-web:$TAG" >> "$GITHUB_STEP_SUMMARY"

name: deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to deploy (e.g., commit SHA)'
        required: true
        type: string
      environment:
        description: 'GitHub Environment to use (secrets/approvals)'
        required: true
        default: 'prod'
        type: choice
        options: [ 'prod' ]
      skip_migrate:
        description: 'Skip DB migration step'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: read

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ github.event.inputs.environment }}
    env:
      IMAGE_PREFIX: ghcr.io/${{ github.repository }}
      TAG: ${{ github.event.inputs.tag }}
      DOCKER_NETWORK: ${{ vars.DOCKER_NETWORK }}
      # For health checks (set these as Environment Variables)
      SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL }}
      API_BASE: ${{ vars.NEXT_PUBLIC_WEB_API_BASE }}
    steps:
      - name: Setup SSH known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          : "${SSH_PORT:=22}"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Write SSH key file
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          umask 077
          printf "%s" "$SSH_KEY" > "$RUNNER_TEMP/deploy_key"
          echo "SSH_KEY_FILE=$RUNNER_TEMP/deploy_key" >> "$GITHUB_ENV"
      - name: Verify inputs
        run: |
          test -n "$TAG" || { echo "tag is required"; exit 1; }

      - name: Prepare health endpoints
        id: health
        run: |
          site="$SITE_URL"; api="$API_BASE"
          site=${site%/}
          api=${api%/}
          echo "site_url=$site" >> $GITHUB_OUTPUT
          echo "api_health=$api/healthz" >> $GITHUB_OUTPUT

      - name: SSH deploy (pull → migrate → restart → health)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_ACTOR: ${{ github.actor }}
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
          TAG: ${{ env.TAG }}
          API_HEALTH: ${{ steps.health.outputs.api_health }}
          WEB_HEALTH: ${{ steps.health.outputs.site_url }}
          SKIP_MIGRATE: ${{ github.event.inputs.skip_migrate }}
          DOCKER_NETWORK: ${{ env.DOCKER_NETWORK }}
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          set -euo pipefail
          : "${SSH_PORT:=22}"
          GHCR_PAT=${GHCR_PAT:-}
          if [ -z "$GHCR_PAT" ]; then
            echo "[deploy] GHCR_PAT secret is required (GitHub Environment: ${DEPLOY_ENV})" >&2
            exit 1
          fi

          WEB_HEALTH_CLEAN="${WEB_HEALTH%/}/"

          printf -v IMAGE_PREFIX_ESC '%q' "$IMAGE_PREFIX"
          printf -v TAG_ESC '%q' "$TAG"
          printf -v GHCR_PAT_ESC '%q' "$GHCR_PAT"
          printf -v GITHUB_ACTOR_ESC '%q' "$GITHUB_ACTOR"
          printf -v API_HEALTH_ESC '%q' "$API_HEALTH"
          printf -v WEB_HEALTH_ESC '%q' "$WEB_HEALTH_CLEAN"
          printf -v SKIP_MIGRATE_ESC '%q' "$SKIP_MIGRATE"
          printf -v DOCKER_NETWORK_ESC '%q' "${DOCKER_NETWORK:-}"

          ssh -i "$SSH_KEY_FILE" -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash -s <<EOF
          set -euo pipefail
          IMAGE_PREFIX=$IMAGE_PREFIX_ESC
          TAG=$TAG_ESC
          GHCR_PAT_INNER=$GHCR_PAT_ESC
          GITHUB_ACTOR_INNER=$GITHUB_ACTOR_ESC
          API_HEALTH=$API_HEALTH_ESC
          WEB_HEALTH=$WEB_HEALTH_ESC
          SKIP_MIGRATE=$SKIP_MIGRATE_ESC
          DOCKER_NETWORK_INNER=$DOCKER_NETWORK_ESC

          echo "\$GHCR_PAT_INNER" | docker login ghcr.io -u "\$GITHUB_ACTOR_INNER" --password-stdin
          cd /srv/sogecon-app
          echo "[deploy] Pulling images..."
          docker pull "\$IMAGE_PREFIX/alumni-api:\$TAG"
          docker pull "\$IMAGE_PREFIX/alumni-web:\$TAG"

          if [ -n "\$DOCKER_NETWORK_INNER" ]; then
            docker network inspect "\$DOCKER_NETWORK_INNER" >/dev/null 2>&1 || docker network create "\$DOCKER_NETWORK_INNER"
          fi

          if [ "\$SKIP_MIGRATE" != "true" ]; then
            API_IMAGE="\$IMAGE_PREFIX/alumni-api:\$TAG" ENV_FILE=.env.api DOCKER_NETWORK="\$DOCKER_NETWORK_INNER" \
              bash ./ops/cloud-migrate.sh
          else
            echo "[deploy] Skip migrate"
          fi

          API_IMAGE="\$IMAGE_PREFIX/alumni-api:\$TAG" \
          WEB_IMAGE="\$IMAGE_PREFIX/alumni-web:\$TAG" \
          DOCKER_NETWORK="\$DOCKER_NETWORK_INNER" \
          API_ENV_FILE=.env.api WEB_ENV_FILE=.env.web \
          bash ./ops/cloud-start.sh

          echo "[deploy] Health checks"
          if [ -n "\$API_HEALTH" ]; then
            curl -fsS -o /dev/null "\$API_HEALTH" || { echo "API health failed"; exit 1; }
          fi
          if [ -n "\$WEB_HEALTH" ]; then
            curl -fsS -o /dev/null "\$WEB_HEALTH" || { echo "WEB health failed"; exit 1; }
          fi
          echo "[deploy] OK"
          EOF

      - name: Summary
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "Deployed to $DEPLOY_ENV" >> "$GITHUB_STEP_SUMMARY"
          echo "Tag: $TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "API: $IMAGE_PREFIX/alumni-api:$TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "WEB: $IMAGE_PREFIX/alumni-web:$TAG" >> "$GITHUB_STEP_SUMMARY"

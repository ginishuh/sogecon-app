name: build-push

on:
  push:
    branches: [ main ]
    # Auto-build only when these paths change on main
    paths:
      - 'apps/**'
      - 'infra/**'
      - 'ops/**'
    tags: [ 'v*', 'release-*' ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default = commit SHA)'
        required: false
        type: string

permissions:
  contents: read
  packages: write

concurrency:
  group: build-push-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-push:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      IMAGE_PREFIX: ghcr.io/${{ github.repository }}
      # Build-time public envs for Next.js (prefer Environment/Repo Variables)
      NEXT_PUBLIC_SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL }}
      NEXT_PUBLIC_WEB_API_BASE: ${{ vars.NEXT_PUBLIC_WEB_API_BASE }}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ vars.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}
      NEXT_PUBLIC_ANALYTICS_ID: ${{ vars.NEXT_PUBLIC_ANALYTICS_ID }}
      NEXT_PUBLIC_ENABLE_SW: ${{ vars.NEXT_PUBLIC_ENABLE_SW }}
      NEXT_PUBLIC_RELAX_CSP: ${{ vars.NEXT_PUBLIC_RELAX_CSP }}
      NEXT_PUBLIC_IMAGE_DOMAINS: ${{ vars.NEXT_PUBLIC_IMAGE_DOMAINS }}
      # AMD64 VPS target; set PLATFORMS to linux/arm64,linux/amd64 if needed
      PLATFORMS: linux/amd64
      USE_BUILDX: 1
      PUSH_IMAGES: 1
      SKIP_WEB: 1
    steps:
      - uses: actions/checkout@v4

      - name: Set IMAGE_TAG (validate input)
        id: tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          TAG="$INPUT_TAG"
          if [ -n "$TAG" ]; then
            if echo "$TAG" | grep -Eq '^[A-Za-z0-9._-]+$'; then
              echo "IMAGE_TAG=$TAG" >> "$GITHUB_ENV"
            else
              echo "Invalid tag format: $TAG" >&2
              exit 1
            fi
          else
            echo "IMAGE_TAG=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images (API only)
        run: |
          ./ops/cloud-build.sh

      - name: Summary
        run: |
          echo "Image prefix: $IMAGE_PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "Tag: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "API: $IMAGE_PREFIX/alumni-api:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "WEB: (skipped; standalone deploy path)" >> $GITHUB_STEP_SUMMARY

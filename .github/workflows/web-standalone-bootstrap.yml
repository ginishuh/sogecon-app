name: web-standalone-bootstrap

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'GitHub Environment (secrets/approvals)'
        required: true
        default: 'prod'
        type: choice
        options: ['prod']

permissions:
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          : "${SSH_PORT:=22}"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Write SSH key file
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          umask 077
          printf "%s" "$SSH_KEY" > "$RUNNER_TEMP/deploy_key"
          echo "SSH_KEY_FILE=$RUNNER_TEMP/deploy_key" >> "$GITHUB_ENV"

      - name: Bootstrap VPS (Node, systemd unit, Nginx site, sudoers)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euo pipefail
          : "${SSH_PORT:=22}"
          ssh -i "$SSH_KEY_FILE" -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" 'set -euo pipefail; \
            echo "[bootstrap] Updating apt cache"; \
            if command -v apt >/dev/null 2>&1; then sudo apt-get update -y; fi; \
            # Install Node.js 22.x (NodeSource) if node missing
            if ! command -v node >/dev/null 2>&1; then \
              if command -v apt >/dev/null 2>&1; then \
                curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -; \
                sudo apt-get install -y nodejs; \
              else \
                echo "[bootstrap] Non-apt distro: please install Node 22.x manually" >&2; \
              fi; \
            fi; \
            node -v || true; \
            # Release dir and permissions
            sudo mkdir -p /opt/sogecon/web/releases; \
            sudo chown "$USER":"$USER" /opt/sogecon/web -R; \
            # Systemd unit from repo clone
            if [ -d /srv/sogecon-app ]; then \
              cd /srv/sogecon-app; \
              sudo cp ops/systemd/sogecon-web.service /etc/systemd/system/sogecon-web.service; \
              sudo systemctl daemon-reload; \
              sudo systemctl enable sogecon-web || true; \
            else \
              echo "[bootstrap] /srv/sogecon-app not found; clone the repo to install unit" >&2; \
            fi; \
            # Nginx site (optional)
            if command -v nginx >/dev/null 2>&1; then \
              if [ -d /srv/sogecon-app ]; then \
                sudo cp /srv/sogecon-app/ops/nginx/nginx-site-web.conf /etc/nginx/sites-available/sogecon-web.conf; \
                sudo ln -sf /etc/nginx/sites-available/sogecon-web.conf /etc/nginx/sites-enabled/sogecon-web.conf; \
                sudo nginx -t && sudo systemctl reload nginx; \
              fi; \
            else \
              echo "[bootstrap] nginx not found; install and configure TLS separately"; \
            fi; \
            # Sudoers for passwordless systemctl
            TMP=$(mktemp); \
            echo "$USER ALL=(ALL) NOPASSWD: /bin/systemctl daemon-reload, /bin/systemctl restart sogecon-web, /bin/systemctl status sogecon-web" > "$TMP"; \
            sudo chown root:root "$TMP"; sudo chmod 440 "$TMP"; \
            sudo mv "$TMP" /etc/sudoers.d/sogecon-web; \
            echo "[bootstrap] Done"'

      - name: Summary
        run: |
          echo "Bootstrap attempted. Verify Node, systemd unit enabled, Nginx reloaded." >> $GITHUB_STEP_SUMMARY

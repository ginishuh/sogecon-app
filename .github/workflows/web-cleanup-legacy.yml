name: web-cleanup-legacy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'GitHub Environment (secrets/approvals)'
        required: true
        default: 'prod'
        type: choice
        options: ['prod']

permissions:
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          : "${SSH_PORT:=22}"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Write SSH key file
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          umask 077
          printf "%s" "$SSH_KEY" > "$RUNNER_TEMP/deploy_key"
          echo "SSH_KEY_FILE=$RUNNER_TEMP/deploy_key" >> "$GITHUB_ENV"

      - name: Verify unit, remove legacy backups under /opt, show disk usage
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euo pipefail
          : "${SSH_PORT:=22}"
          ssh -i "$SSH_KEY_FILE" -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" 'set -euo pipefail; \
            echo "[check] systemd WorkingDirectory:"; \
            sudo systemctl cat sogecon-web | sed -n "s/^WorkingDirectory=//p" || true; \
            echo "[check] current symlink:"; \
            readlink -f /srv/www/sogecon/current || { echo "missing /srv/www/sogecon/current" >&2; exit 1; }; \
            echo "[du] before:"; \
            (du -sh /srv/www/sogecon 2>/dev/null || true); (du -sh /opt/sogecon 2>/dev/null || true); \
            echo "[legacy] listing backups under /opt/sogecon:"; \
            (ls -1d /opt/sogecon/web.backup.* 2>/dev/null || echo "(none)"); \
            echo "[legacy] removing backups..."; \
            find /opt/sogecon -maxdepth 1 -mindepth 1 -type d -name "web.backup.*" -print -exec sudo rm -rf {} + 2>/dev/null || true; \
            echo "[legacy] done"; \
            echo "[du] after:"; \
            (du -sh /srv/www/sogecon 2>/dev/null || true); (du -sh /opt/sogecon 2>/dev/null || true)'

      - name: Summary
        run: |
          echo "Legacy backups under /opt cleaned if present." >> $GITHUB_STEP_SUMMARY


#!/usr/bin/env bash
set -euo pipefail

mapfile -t FILES < <(git diff --cached --name-only --diff-filter=ACMRTUXB)

if [ "${#FILES[@]}" -eq 0 ]; then
  exit 0
fi

doc_only=true
for file in "${FILES[@]}"; do
  if [[ "$file" =~ ^docs/ ]] || [[ "$file" =~ \.(md|MD|txt|adoc|rst)$ ]] || [[ "$file" == README.md ]] || [[ "$file" == CONTRIBUTING.md ]] || [[ "$file" == SECURITY.md ]] || [[ "$file" == LICENSE ]]; then
    continue
  else
    doc_only=false
    break
  fi
done

if [ "$doc_only" = true ]; then
  echo "[hooks] Docs-only change detected; skipping pre-commit checks."
  exit 0
fi

# Repo guards on staged files (policy: no suppression comments, max lines, etc.)
if command -v python3 >/dev/null 2>&1; then
  echo "[hooks] Running repo guards"
  python3 ops/ci/guards.py || { echo "[hooks] Repo guards failed"; exit 1; }
else
  echo "[hooks] Warning: python3 not found; skipping repo guards"
fi

worklog_staged=false
for file in "${FILES[@]}"; do
  if [[ "$file" == docs/worklog.md ]]; then
    worklog_staged=true
    break
  fi
done

if [ "$worklog_staged" = false ]; then
  echo "[hooks] docs/worklog.md must be updated for non-documentation changes."
  exit 1
fi

python_targets=()
for file in "${FILES[@]}"; do
  if [[ "$file" == *.py ]]; then
    python_targets+=("$file")
  fi
done

web_targets=()
for file in "${FILES[@]}"; do
  if [[ "$file" == apps/web/* ]] && [[ "$file" =~ \.(ts|tsx|js|jsx)$ ]]; then
    web_targets+=("${file#apps/web/}")
  fi
done

if [ ${#python_targets[@]} -gt 0 ]; then
  RUFF_BIN=""
  if [ -n "${VIRTUAL_ENV:-}" ] && [ -x "$VIRTUAL_ENV/bin/ruff" ]; then
    RUFF_BIN="$VIRTUAL_ENV/bin/ruff"
  elif [ -x ".venv/bin/ruff" ]; then
    RUFF_BIN=".venv/bin/ruff"
  elif command -v ruff >/dev/null 2>&1; then
    RUFF_BIN="ruff"
  fi
  if [ -n "$RUFF_BIN" ]; then
    echo "[hooks] Running ruff on changed Python files ($RUFF_BIN)"
    "$RUFF_BIN" check --force-exclude "${python_targets[@]}"
  else
    echo "[hooks] Warning: ruff not found; skipping Python lint"
  fi
fi

# 임시(반드시 원복): e2e 제외 — glm-4.6 우회; see #29; remove by 2025-10-31
if [ ${#web_targets[@]} -gt 0 ]; then
  WEB_FILTERED=()
  for file in "${web_targets[@]}"; do
    if ! [[ "$file" =~ (^e2e/)|(.e2e.)|(playwright.config.) ]]; then
      WEB_FILTERED+=("$file")
    fi
  done

  if [ ${#WEB_FILTERED[@]} -gt 0 ]; then
    if command -v pnpm >/dev/null 2>&1; then
      echo "[hooks] Running ESLint (flat config) on web (app/components/hooks/lib) — e2e excluded"
      (cd apps/web && pnpm exec eslint app components hooks lib --ext .ts,.tsx,.js,.jsx --max-warnings=0 --ignore-pattern .next --ignore-pattern "e2e/**" --ignore-pattern "vitest.config.e2e.ts")
      # Type-check is covered in CI build; skipping here to keep commits fast
    else
      echo "[hooks] Warning: pnpm not found; skipping web lint/type-check"
    fi
  else
    echo "[hooks] web: only e2e changes detected; skipping eslint/tsc temporarily."
  fi
fi

exit 0

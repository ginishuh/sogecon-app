#!/usr/bin/env bash
set -euo pipefail

if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  mapfile -t FILES < <(git log --format= --name-only @{u}..HEAD | sort -u)
else
  mapfile -t FILES < <(git log --format= --name-only HEAD | sort -u)
fi

pruned_files=()
for file in "${FILES[@]}"; do
  if [ -n "$file" ]; then
    pruned_files+=("$file")
  fi
done
FILES=("${pruned_files[@]}")

# Drop ephemeral/dev artifacts that may appear in historical commits but should
# not influence hook decisions for the current push.
filtered=()
for file in "${FILES[@]}"; do
  case "$file" in
    # logs and runtime pids
    logs/*|*.log|*.pid)
      continue
      ;;
    # build outputs & caches
    apps/web/.next/*|node_modules/*|packages/schemas/node_modules/*)
      continue
      ;;
    # python caches
    **/__pycache__/*)
      continue
      ;;
    *)
      filtered+=("$file")
      ;;
  esac
done
FILES=("${filtered[@]}")

if [ "${#FILES[@]}" -eq 0 ]; then
  exit 0
fi

resolve_python_bin() {
  if [ -n "${VIRTUAL_ENV:-}" ] && [ -x "$VIRTUAL_ENV/bin/python" ]; then
    echo "$VIRTUAL_ENV/bin/python"
    return
  fi
  if [ -x ".venv/bin/python" ]; then
    echo ".venv/bin/python"
    return
  fi
  if command -v python >/dev/null 2>&1; then
    command -v python
    return
  fi
  echo ""
}

doc_only=true
for file in "${FILES[@]}"; do
  if [[ "$file" =~ ^docs/ ]] || [[ "$file" =~ \.(md|MD|txt|adoc|rst)$ ]] || [[ "$file" == README.md ]] || [[ "$file" == CONTRIBUTING.md ]] || [[ "$file" == SECURITY.md ]] || [[ "$file" == LICENSE ]]; then
    continue
  else
    doc_only=false
    break
  fi
done

if [ "$doc_only" = true ]; then
  echo "[hooks] Docs-only push detected; skipping pre-push checks."
  exit 0
fi

devlog_present=false
for file in "${FILES[@]}"; do
  if [[ "$file" =~ ^docs/dev_log_[0-9]{6}\.md$ ]]; then
    devlog_present=true
    break
  fi
done

if [ "$devlog_present" = false ]; then
  echo "[hooks] Include a docs/dev_log_YYMMDD.md update with non-documentation changes."
  exit 1
fi

python_changed=false
req_changed=false
web_changed=false
api_contract_changed=false
for file in "${FILES[@]}"; do
  if [[ "$file" == *.py ]]; then
    python_changed=true
  fi
  if [[ "$file" == apps/api/requirements.txt || "$file" == apps/api/requirements-dev.txt ]]; then
    req_changed=true
  fi
  if [[ "$file" == apps/web/* ]] && [[ "$file" =~ \.(ts|tsx|js|jsx)$ ]]; then
    web_changed=true
  fi
  if [[ "$file" == apps/api/* ]] || [[ "$file" == packages/schemas/* ]] || [[ "$file" == scripts/export_openapi.py ]]; then
    api_contract_changed=true
  fi
done

PY_BIN="$(resolve_python_bin)"

if [ "$python_changed" = true ]; then
  if [ -z "$PY_BIN" ]; then
    echo "[hooks] Error: python runtime not found."
    exit 1
  fi

  if "$PY_BIN" -m pyright --version >/dev/null 2>&1; then
    echo "[hooks] Running pyright type check"
    "$PY_BIN" -m pyright --project pyrightconfig.json
  else
    echo "[hooks] Warning: pyright not available; skipping type check"
  fi

  # If requirements changed, install to local venv before running tests
  if [ "$req_changed" = true ]; then
    echo "[hooks] Installing updated Python dependencies (requirements changed)"
    "$PY_BIN" -m pip install -r apps/api/requirements.txt -r apps/api/requirements-dev.txt
  fi

  # Note: pytest is now handled by CI to speed up local pushes
  echo "[hooks] Tests will be run by CI - skipping local pytest execution"

  if [ -z "$PY_BIN" ]; then
    echo "[hooks] Error: python runtime not found for bandit scan."
    exit 1
  fi

  if "$PY_BIN" -m bandit --version >/dev/null 2>&1; then
    echo "[hooks] Running bandit security scan"
    "$PY_BIN" -m bandit -r apps/api -x apps/api/migrations -q
  else
    echo "[hooks] Error: bandit not available in active environment."
    echo "[hooks] Install with: $PY_BIN -m pip install -r apps/api/requirements-dev.txt"
    exit 1
  fi
fi

## Web build is handled by CI. Pre-push does not build the web app.

if [ "$api_contract_changed" = true ]; then
  if [ -z "$PY_BIN" ]; then
    echo "[hooks] Error: python runtime not found for OpenAPI export."
    exit 1
  fi
  if ! command -v pnpm >/dev/null 2>&1; then
    echo "[hooks] Error: pnpm not found for DTO generation."
    exit 1
  fi

  echo "[hooks] Verifying OpenAPI/DTO sync"
  "$PY_BIN" scripts/export_openapi.py
  pnpm -C packages/schemas run gen-dts

  if ! git diff --quiet -- packages/schemas/openapi.json packages/schemas/index.d.ts; then
    echo "[hooks] Error: OpenAPI/DTO artifacts are out of sync."
    echo "[hooks] Run: make schema-gen"
    echo "[hooks] Then commit updated schema files:"
    echo "  - packages/schemas/openapi.json"
    echo "  - packages/schemas/index.d.ts"
    exit 1
  fi
fi

exit 0

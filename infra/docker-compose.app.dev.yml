services:
  api_dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: infra/api.Dockerfile
    environment:
      APP_ENV: dev
      WATCHFILES_FORCE_POLLING: "1"  # WSL2/volume 변경 감지 안정화
      DATABASE_URL: postgresql+psycopg://app:devpass@postgres:5432/appdb
      CORS_ORIGINS: '["http://localhost:3000"]'
      JWT_SECRET: change-me
    volumes:
      - ./apps/api:/app/apps/api:cached
      - ./uploads:/app/uploads
    ports:
      - "127.0.0.1:3001:3001"
    depends_on:
      - postgres
    command: ["uvicorn","apps.api.main:app","--host","0.0.0.0","--port","3001","--reload"]

  web_dev:
    profiles: ["dev"]
    image: node:22.17.1-slim
    working_dir: /app
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_PUBLIC_WEB_API_BASE: http://localhost:3001
      NEXT_PUBLIC_SITE_URL: http://localhost:3000
      NEXT_PUBLIC_ENABLE_SW: "1"
    volumes:
      - .:/app:cached
    ports:
      - "127.0.0.1:3000:3000"
    # Next dev(HMR); corepack로 pnpm 준비 후 워크스페이스 설치
    command: >-
      bash -lc "corepack enable && corepack prepare pnpm@10.17.1 --activate \
      && pnpm -C apps/web install \
      && pnpm -C apps/web dev --host"
    depends_on:
      - api_dev

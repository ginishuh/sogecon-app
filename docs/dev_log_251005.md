# 2025-10-05 개발 기록

- 모바일 웹 우선 전략 명문화: 반응형 기준/성능 목표(LCP/INP/CLS) 설정.
- PWA/Web Push 지원을 1차 채널로 채택, SMS 발송은 보류.
- `docs/architecture.md`에 PWA/푸시 아키텍처 섹션 추가.
- `docs/pwa_push.md` 신설: 키 관리(VAPID), 구독/발송 API 초안, 프런트/백엔드 구현 절차, 테스트 체크리스트 정리.
- `docs/todo.md`에 PWA 관련 작업 항목 추가.
- 보안 하드닝 추가: 보안 헤더(웹/API), Repo Guards, Bandit/pip-audit/pnpm audit/Semgrep/CodeQL CI 연동, `docs/security_hardening.md` 신설.
- 버전 규격화: 글로벌 런타임(node 22.17.1, pnpm 10.17.1, Python 3.12.3) 기준으로 엔진 고정, 의존성 최신 안정화 버전으로 업데이트 및 CI 검사 스텝 추가(`ops/ci/check_versions.py`).
- 에이전트 베이스: 언어/커뮤니케이션 규칙 추가(코드 주석/문서/커밋/PR은 한국어 기본, 예외 항목 명시).
- pre-push에서 웹 빌드 제거(CI 전용), pre-commit ESLint CLI로 이관
- ESLint 검사 대상을 app 디렉터리로 한정(.mjs 등 비대상 파일 제외)
- Tailwind v3.4.13로 롤백 및 PostCSS 설정 복원
- gitleaks 액션 입력 경고 제거(args 제거) 및 전체 이력 fetch로 분석 안정화
- ruff 설정에서 migrations/versions 제외 처리
- CI에서 Corepack으로 pnpm 버전(10.17.1) 고정
- 루트 package.json에 packageManager 고정(`pnpm@10.17.1`) 추가 및 CI 버전 검사에 포함
- 루트 package.json 제거(엔진 고정은 apps/web + CI Corepack으로 일원화)
- CI를 PR 전용으로 전환(concurrency 포함), Draft PR은 스킵 후 Ready에서 전체 실행
- 에이전트 문서 동기화: `AGENTS.md`/`CLAUDE.md`/`copilot-instructions.md`에 `docs/agents_base.md` 전체를 verbatim으로 삽입(각 문서가 단독으로 완결되도록 함)
 - 한글 베이스 업데이트: `docs/agents_base_kr.md`에 SSOT 섹션 추가(architecture/pwa_push/versions/security_hardening/SECURITY 앵커 포함)
 
## 설계/리팩터링(SSOT 반영)
- 백엔드: 라우터가 ORM을 직접 접근하지 않도록 서비스/리포지토리 레이어 스캐폴드 추가
  - 추가: `apps/api/errors.py`, `apps/api/services/*`, `apps/api/repositories/*`
  - 변경: `apps/api/routers/{members,posts,events,rsvps}.py`가 서비스 호출로 위임하도록 리팩터링
- 프런트엔드: 컴포넌트 → 서비스 → API 클라이언트 레이어 도입
  - 추가: `apps/web/lib/api.ts`, `apps/web/services/{posts,events}.ts`
  - 변경: `apps/web/app/{posts,events}/page.tsx`에서 직접 fetch 제거 후 서비스 호출로 전환
- 문서: `docs/architecture.md`에 레이어드 아키텍처(강제) 문구 반영, 프런트/백엔드 구조 설명 갱신

## 예외 전략(절충안 채택)
- 서비스/리포지토리: 도메인 예외에 안정적인 `code` 포함(`ApiError` 파생: `NotFoundError`, `AlreadyExistsError`, `ConflictError`)
- FastAPI 전역 핸들러: 단일 핸들러가 Problem Details(JSON; 최소 필드)로 변환하고 HTTP status 매핑
- 라우터: try/except 제거, 서비스 호출만 수행

## 테스트 준비(pytest)
- TestClient 기반 API 스모크 테스트 도입(로컬 SQLite 임시 DB로 의존성 오버라이드)
- 케이스: `member_not_found` 404, `member_exists` 409 Problem Details 응답 검증

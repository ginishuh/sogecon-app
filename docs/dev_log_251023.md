# 2025-10-23 개발 로그

## 작업 요약
- 마이그레이션 재설정 및 환경변수 개선
- 개발 환경 자동화 개선
- Enum 라벨 소문자 일관화(모델/마이그레이션 정정)

## 상세 작업 내용

### 1. 마이그레이션 재설정
- 기존 15개 마이그레이션 파일 삭제 및 백업
- 단일 초기 마이그레이션으로 통합 (559d5829569f_initial_migration_with_all_models.py)
- PostgreSQL 마이그레이션 시 version_num 필드 길이 문제 해결
- 데이터베이스 스키마 완전 재구성
  - 10개 테이블: members, posts, events, rsvps, admin_users, member_auth, push_subscriptions, notification_preferences, notification_send_logs
  - 29개 인덱스 정상 생성
- SQLite와 PostgreSQL 모두에서 마이그레이션 검증 완료

### 1-b. Enum 라벨(대문자 → 소문자) 정정
- 원인: SQLAlchemy `Enum` 기본 동작이 Python Enum의 name(대문자)을 사용하여, 자동생성 리비전에 대문자 라벨이 생성됨.
- 조치(모델): `apps/api/models.py`에서 `Enum(..., values_callable=lambda e: [m.value for m in e])` 지정으로 DB 라벨을 value(소문자)로 강제.
- 조치(마이그레이션): `alembic revision --autogenerate` 결과가 비어 자동 감지되지 않아 수동 스크립트 추가.
  - 파일: `apps/api/migrations/versions/d1f6730b2503_fix_api_lowercase_enum_labels_for_.py`
  - Postgres 전용으로 `ALTER TYPE visibility/rsvpstatus RENAME VALUE 'UPPER' TO 'lower'` 수행.
  - SQLite는 CHECK 제약 기반이며 새 스키마가 이미 소문자라 추가 조치 불필요.

### 2. 개발 환경 자동화 개선
- Makefile에 DB 컨테이너 자동 시작 의존성 추가
  - api-dev: db-up 의존성 추가
  - api-start: db-up 의존성 추가  
  - dev-up: db-up 의존성 추가
- db-up 타겟 개선
  - 상세 로그 메시지 추가
  - Docker 실행 상태 확인
  - 데이터베이스 준비 상태 대기 (health check)
  - 타임아웃 처리 (60초)

### 3. 환경변수 설정 정리
- .env.example 개선
  - 중복 설정 제거 (VAPID, DB 포트, 레이트 리밋)
  - 누락된 필드 추가 (레이트 리밋, Web Push, Docker 포트)
  - CORS_ORIGINS JSON 배열 형식으로 명확화
- .env.dev 파일 생성
  - 개발용 PostgreSQL 설정 (포트 5433)
  - 테스트용 SQLite 설정 (TEST_DB=sqlite)
  - 모든 필수 설정 포함

### 4. 기타 개선
- 마이그레이션 템플릿 파일(script.py.mako) 복원
- Docker Compose 경고 메시지 수정

## 검증 결과
- ✅ SQLite: 마이그레이션 성공, 10개 테이블 생성
- ✅ PostgreSQL: 마이그레이션 성공, 10개 테이블 + 29개 인덱스 생성
- ✅ make api-dev: DB 컨테이너 자동 시작 확인
- ✅ 환경변수 중복 제거 및 설정 정리 완료

## 다음 작업
- 전체 디버깅 환경 테스트
- API 서버 시작 및 마이그레이션 자동화 확인

### 5. 학번 기반 인증 시스템 구현 (추가)
- **모델 변경**: Member, MemberAuth, AdminUser 모델에 student_id 필드 추가
- **인증 로직 변경**: 이메일 기반 로그인을 학번 기반으로 전환 (auth.py 라우터 수정)
- **시드 데이터 생성**:
  - 개발용 시드 (seed_data.py): 관리자(s47053/허민철) + 테스트 멤버 계정들
  - 운영용 시드 (seed_production.py): 최소한의 운영 관리자 계정
- **패키지 구조 개선**: repositories/, services/ 디렉토리에 __init__.py 파일 추가로 import 오류 해결
- **마이그레이션 파일**: 학번 필드 추가를 위한 3개 마이그레이션 파일 생성
  - 3c1fa6c678e1_add_student_id_to_member_and_member_auth.py
  - 72d4bb051add_add_student_id_to_admin_user.py
  - f2b5a9b1cafe_sqlite_fix_lowercase_enums.py
- **코드 품질**: 모든 lint 오류 해결 (ruff, pyright 통과)

**테스트 확인**:
- 관리자 로그인: s47053/admin1234 ✅
- 멤버 로그인: s47054/member1234 ✅
- API 서버 안정적 운영 확인

## 추가 개선 (후기)
- 개발 워크플로우 최적화: pre-push 훅에서 pytest 제거
  - 로컬 푸시 속도 향상 (약 77초 → 1초 이내)
  - CI에서 테스트 실행으로 중복 제거
  - 개발자 경험 개선 및 빠른 피드백 루프 확보

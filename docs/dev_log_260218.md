# 2026-02-18

- Added: `apps/api/reset_data.py` 원타임 데이터 리셋 커맨드 추가 (`ALLOW_DESTRUCTIVE_RESET=1` 가드)
- Added: 회원 전환 대상 테이블 삭제 순서 및 스키마 미존재(`signup_requests`) 자동 스킵 처리
- Added: `tests/api/test_reset_data.py` 가드 검증/선별 삭제/로그 보존 테스트 추가
- Ops: `Makefile`에 `reset-data` 타깃 추가
- Docs: `docs/issue113_data_reset_runbook.md` 실행 절차/주의사항 문서화
- Docs: `docs/worklog.md` 삭제 및 정책을 commit/PR + `docs/dev_log_YYMMDD.md` 중심으로 전환
- Fixed: PR 리뷰 반영 — `admin_users`를 리셋 대상에 추가하고 `events`/`hero_items` 보존 의도 및 범위를 런북에 명시
- Fixed: 리셋 SQL 생성부 화이트리스트 검증 추가 및 테스트 보강(admin 삭제/콘텐츠 보존 검증)
- Ops: `pre-push`에 Python 변경 시 Bandit 보안 스캔 추가, `requirements-dev`에 `bandit` 핀 추가
- Feat: #115 착수 — `members.status`/`signup_requests` 모델·마이그레이션 추가, 시드를 관리자 bootstrap 전용으로 재구성
- Fixed: PR #121 리뷰 반영 — `MemberCreate`에 `status` 노출 제거, `seed-admin` alias 중복 정의 정리
- Chore: PR #121 CI(verify-dto) 대응으로 `packages/schemas/openapi.json`, `packages/schemas/index.d.ts` 재생성 반영
- Feat: #116 착수 — `POST /auth/member/signup`, 관리자 심사 API(`GET/approve/reject /admin/signup-requests`) 및 `admin_signup` 권한 가드 추가
- Feat: `roles_service` 단일 파서 도입 및 `signup_requests`에 `phone`/`note` 컬럼 확장(+ Alembic `b6d2e8f1c4a7`)
- Test: `tests/api/test_signup_requests_api.py` 추가(신청/중복/활성충돌/권한403/승인·반려 플로우 검증)
- Feat: #117 착수 — 활성화 토큰을 `URLSafeTimedSerializer`(72h TTL)로 전환하고 승인 기반 1회성(`activated_at`) 검증 적용
- Feat: `login_member`에 `members.status=active` 게이트 적용, `/auth/session`에 `roles: string[]` 응답 보장
- Feat: 승인 응답에 `activation_token` 포함 및 활성화 성공 시 통합 `user` 세션 설정으로 레거시 세션 버그 제거
- Test: `tests/api/test_abc_phase1.py` 갱신(승인 기반 활성화, 만료/위조/재사용 차단, inactive 로그인 차단)
- Fix: PR #123 리뷰 반영 — 활성화 helper 반환 타입 구체화, 레거시 `/auth/session` roles를 DB 기반으로 정규화
- Fix: `dto-verify` 재발 방지 — pre-push에서 API 계약 변경 시 OpenAPI/DTO 동기화 강제(불일치 시 push 차단) + `agents_base`(영/한) 규칙 명시
- Feat: #118 착수 — `admin_roles` 권한 토글 API(`GET/PATCH /admin/admin-users`) 추가 및 `require_super_admin` 의존성 도입
- Feat: 관리자 라우터 RBAC 가드 전환(`admin_posts`, `admin_events`, `admin_hero`, `admin_notifications`, `admin_signup`) 및 strict permission(`allow_admin_fallback=False`) 적용
- Refactor: `auth_service` 600줄 리스크 해소를 위해 활성화 토큰/검증 로직을 `activation_service`로 분리
- Test: RBAC 회귀/신규 테스트 추가(`test_admin_roles_api.py`) 및 관리자/멤버 접근 제어 케이스 갱신(49 passed)
- Fix: PR #124 리뷰 반영 — self demotion/마지막 super_admin 제거 차단, 권한 변경 감사 로그(`roles_updated`) 추가
- Notes: strict permission 적용으로 레거시 관리자 세션은 재로그인 후 최신 `user.roles`를 받아야 하며, 일부 관리자 경로는 401 대신 403(`admin_permission_required`)을 반환
- Notes: 이슈 #114 작업 착수, Epic #113 하위 이슈 순서에 맞춰 진행
- Feat: #119 착수 — 웹 RBAC 공통 유틸(`lib/rbac.ts`) 및 `RequirePermission` 가드 추가, 기존 admin 화면 접근 제어를 권한 토큰 기반으로 전환
- Feat: 사용자 가입신청 UI(`/signup`) 및 관리자 심사 UI(`/admin/signup-requests`), 관리자 권한 토글 UI(`/admin/admin-users`) 구현
- Feat: 로그인/활성화 UX 정비(로그인 화면 신규가입 링크, 활성화 토큰 복사·입력 플로우), 헤더/드로어 관리자 메뉴를 `roles` 기반으로 동적 노출
- Test: 웹 검증 — `vitest`(rbac/board) 통과, `next build` 성공(신규 경로 빌드 포함)
- Fix: PR #125 리뷰 반영 — `/activate`를 Suspense 경계 패턴으로 수정(`useSearchParams` hydration 리스크 해소)
- Refactor: `admin/signup-requests` 페이지를 `page.tsx` + `view.tsx`로 분리해 파일 길이 리스크 완화(가독성/확장성 개선)
- Chore: 관리자 권한 안내 문구의 code 스타일(`<code>`) 적용 및 drawer의 `RequireAdmin` 유지 의도 주석 추가
- Feat: #119 2차 반영 — `/admin/signup-requests`, `/admin/admin-users` 모바일 카드 UI와 데스크톱 테이블 동시 제공, 에러/성공 인라인 배너 공통화
- Feat: 가입/활성화 화면(`/signup`, `/activate`) 피드백 메시지 일관화 및 액션 후 안내 문구 정비
- Test: `apps/web/e2e/onboarding-happy-path.spec.ts` 추가(가입신청 → 관리자 승인 → 활성화 happy path)
- Notes: 로컬 E2E 단건 실행 시 Chrome 바이너리 미설치로 스킵 확인(`Could not find Chrome ver. 143.0.7499.169`)

# dev_log_251006

- tests/api/conftest.py에서 `sys.path` 수정 로직을 제거하고 상단 import로 정리했습니다.
- `# noqa: E402` 우회 주석 3건 삭제 → 레포 품질 가드(우회 주석 금지) 준수.
- FastAPI TestClient/SQLite 임시 DB 기반 픽스처 동작은 동일합니다.
- 후속: PR 리뷰 스레드에 반영 코멘트 및 resolve 처리.
 - CI: Python 잡에 Pytest Guard + pytest 실행 단계 추가(테스트 최소 보장).
- 테스트 확장: 404(post/event/rsvp), 409(rsvp_exists), events rsvp upsert(생성/업데이트), 잘못된 enum→422.
- CI: gitleaks PR 스캔 오류 수정 — 워크플로에 `GITHUB_TOKEN` 전달 및 `permissions: pull-requests: read` 추가.
- Web(M1-1): react-query 도입 및 리스트/상세(이벤트) 적용, RSVP UI/액션 추가, 오류 코드→UX 매핑 유틸 추가.
- Web(M1-2): 게시글/행사 생성 폼 추가(`/posts/new`, `/events/new`), 네비게이션 연결.
- API: RSVP capacity v1 적용(going 초과 시 waitlist 강제) 및 성공 경로 테스트 추가.
 - Web: 간단 토스트 컴포넌트 도입 및 생성/RSVP 성공·에러 피드백 연결.
- 테스트: 목록 200, /rsvps 생성 201 스모크 추가.
- Dev: VS Code `.vscode/launch.json` 추가(API SQLite/PG, Web, 복합 실행).
- Repo: .gitignore에서 `.env.example`을 추적하도록 수정(`!.env.example`).
 - .env.example 정리: 개발 기본 DB를 Postgres(5433)로 설정, SQLite는 옵션으로 주석. NEXT_PUBLIC_WEB_API_BASE로 웹 변수 통일.
- Docker Postgres 포트 변경: 5433:5432, VS Code launch(Postgres)도 5433으로 동기화.
- 테스트 DB 스위치: 기본 SQLite, TEST_DB=pg + TEST_DB_URL로 Postgres 테스트 가능(안전가드 포함).
- 테스트 전용 Postgres 컨테이너 추가(5434): Make 타깃(db-test-up), VS Code 런치(Pytest PG) 추가.
- 리뷰 반영(P1): RSVP capacity 계산 시 기존 참석자 제외, apiFetch가 서버 오류 code 보존하도록 수정.
- 보안: bandit(B101) 지적된 assert 제거(이벤트 정원 검사에 사전 조회한 capacity 사용).
- M2 착수: 세션 인증(/auth), SessionMiddleware 추가, admin_users/RSVP.created_at 마이그레이션, 작성 라우트 보호(require_admin), RSVP v2 승급 로직, 인증 테스트 추가.
- Web(M2): /login 페이지 추가, useAuth 훅/헤더 인증 UI, 보호 라우트(posts/new, events/new) 가드 적용, fetch에 credentials 포함.
- 문서: M1 계획서(docs/m1_plan.md) 작성 및 PR 본문 링크 추가 예정.
- 문서: 실행 계획(로드맵) 문서 추가(docs/execution_plan_251006.md).
- 마무리: /auth 로그인 레이트리밋(5/min) 추가, RSVP v2 승급 회귀 테스트, import 정리.
 - 웹 빌드: /login에서 useSearchParams를 Suspense로 감싸 Next 빌드 에러 해결.

## M3 시작
- 브랜치 `feat/m3-webpush` 생성.
- `docs/m3_plan.md` 초안 추가(스코프/DoD/체크리스트/보안 노트).
- 실행 계획(docs/execution_plan_251006.md)에 M3 진행 상태 표기.
- API 모델/마이그레이션 스캐폴드: `push_subscriptions`, `notification_preferences` 테이블 추가(0004/0005). 라우터 `notifications.py` 스텁 3개 엔드포인트.
 - 타입 보강: 클래식 SQLAlchemy 매핑에서 속성 대입을 `setattr` 사용으로 전환(pyright 호환).
- Web: SW push/notificationclick 핸들러, 구독 유틸/서비스, 구독 CTA 추가. 204 응답 처리 위해 apiFetch 보완.
 - Web(Admin): `/admin/notifications` 테스트 발송 페이지 추가(제목/본문/URL).
 - API: `/admin/notifications/test` payload에 `url` 지원, 404/410 자동 폐기 유지.
- API(Admin): 발송 로그/통계 추가 — `notification_send_logs` 테이블(해시/테일 저장), `/admin/notifications/logs`, `/admin/notifications/stats` 구현.
- Web(Admin): 요약/로그 테이블 및 새로고침 추가 — `/admin/notifications`에서 활성 구독, 최근 성공/실패, 최근 로그(시간/결과/코드/말미) 표시.
- Web: apiFetch 복잡도(ESLint complexity) 10 이하로 리팩터링.
- 문서: agents_base(en/kr)와 architecture.md에 결정사항 반영(로컬 API+도커 DB, 포트 변수, CORS JSON, Web Push 운영/프라이버시, Admin 경로).
 - Web: dev에서 ServiceWorkerRegister 컴포넌트 자체 렌더를 막아(SW 완전 비활성) RSC 스트림 "Connection closed" 현상 완화. 필요 시 NEXT_PUBLIC_ENABLE_SW=1로 강제 가능.
 - 코드 스타일: notifications 라우터 import를 절대경로로 재정렬(ruff I001 경고 해소).

### 야간 안정화(Dev)
- CSP(dev) 업데이트: `connect-src`에 `ws:` 허용(HMR/RSC 스트림), `script-src`는 dev에서 인라인/이발 허용(프로덕션은 엄격 유지).
- RSC 진단 미들웨어 추가(`apps/web/middleware.ts`): `__flight__`/`text/x-component` 요청을 서버 콘솔에 `[RSC] ...` 로깅.
- favicon 404 제거: `apps/web/app/favicon.ico/route.ts`(204) 추가로 Network 잡음 감소.
- Makefile 품 개선: `api-start|stop|restart|status`, `web-*`, `dev-up|down|status` 추가. Uvicorn `--reload-dir apps/api`로 리로드 범위 축소.
- 훅 개선: pre-push에서 로그/캐시/빌드 산출물 필터링해 과거 커밋의 잡파일이 훅 판단에 영향 주지 않도록 조정.

### 리뷰 반영(M2/M3 PR)
- API(WebPush): 광역 `except Exception` 제거 → `ValueError|TypeError|RuntimeError|RequestException`로 한정(레포 가드 준수).
- API(RSVP): 취소 시 승급 로직을 SAVEPOINT(begin_nested)로 묶고, Postgres에선 `FOR UPDATE SKIP LOCKED`로 경쟁 완화. 헬퍼 함수로 분리해 복잡도 규칙(≤10) 유지.
- Web: Next.js 미들웨어에서 불변 헤더 수정 문제 수정(Headers 복제 후 전달).
- Migrations: 0001을 SQLite 호환(dialect 분기, `sa.Enum(..., native_enum=False)`)으로 조정.
- Tests: 더미 push provider에 명시적 타입 추가(`# type: ignore` 제거).

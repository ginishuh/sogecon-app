## 2025-11-03

### PG-only 전환 & 네트워크 옵션
- 정책: 데이터베이스 백엔드를 PostgreSQL로 전면 통일. SQLite 경로/예시 제거.
- API 설정: `apps/api/config.py`에 `postgresql+psycopg://` 강제 검증 추가, 기본값 dev PG(5433).
- Alembic: 기본 URL을 PG(5433)로 변경(`apps/api/alembic.ini`).
- DB 헬퍼: SQLite 분기 제거(`apps/api/db.py`).
- 테스트: `tests/api/conftest.py` PG 전용화, 기본 `localhost:5434/appdb_test` 사용.
- 배포: `ops/cloud-migrate.sh` `DOCKER_NETWORK` 지원, `scripts/deploy-vps.sh --network` 추가.
- CI 배포: `.github/workflows/deploy.yml`이 `vars.DOCKER_NETWORK`를 읽어 원격 네트워크 생성/전달.
- 문서: README, `.env*.example`, 런북(한/영), 가이드(AGENTS/COPILOT/CLAUDE), `docs/architecture.md`, `ops/deploy_api.md`를 “PostgreSQL만 지원”으로 통일. Alembic 네트워크 사용 예시 추가.

### 웹 CSP 강화 (#40)
- Next.js 미들웨어에서 요청별 nonce를 생성해 `Content-Security-Policy`에 `'nonce-…'`를 주입.
- App Router 레이아웃이 nonce 헤더를 읽어 Analytics 스크립트에 전달하도록 수정.
- Relax 환경(`NEXT_PUBLIC_RELAX_CSP=1`/비프로덕션)에서는 기존 완화 지시어 유지, 운영에서는 `'unsafe-inline'` 제거.

문서
- README, `docs/security_hardening.md`에 nonce 기반 CSP 운용 지침 정리.

테스트
- `pnpm -C apps/web test` (환경변수: `PNPM_IGNORE_NODE_ENGINE=1 PNPM_ENGINE_STRICT=false npm_config_engine_strict=false`) ✅
- `pnpm -C apps/web exec vitest run __tests__/csp.test.ts __tests__/middleware.test.ts` ✅
- Vitest 환경에서 `next/image` 모킹 시 DOM 미지원 속성(priority 등)을 제거해 JSDOM 경고 방지
- `generateNonce` 유틸을 분리하고 단위 테스트 추가, `style-src 'unsafe-inline'` 유지 근거를 README/security_hardening에 명시
- `pnpm -C apps/web build` ✅ (엔진 강제 옵션 포함)
- `.github/workflows/create-waiver-issue.yml` 개선 — push(main) 트리거 + noop job 추가, dispatch에서만 이슈 생성 로직 실행
- `.github/workflows/deploy.yml`에서 GHCR_PAT 미설정 시 선행 검증, SSH 원격 스크립트에 env를 안전 전송(printf %q), 서비스 루트 경로 `/srv/sogecon-app` 반영
- `.github/workflows/create-waiver-issue.yml` env 값을 따옴표로 감싸 YAML 파서 오류를 방지
 
### 로컬(WSL2) 배포 미러링
- ops/make: `ghcr-login`, `pull-images`, `deploy-local` 타깃 추가 — GHCR 로그인 및 VPS 동형 배포(pull→migrate→restart) 원샷 실행
- docs: `docs/agent_runbook_wsl2.md` 추가 — 로컬에서 VPS와 동일한 배포 흐름 재현 가이드

### 로컬 자동기동 정리 & Compose 기본화
 - compose: 루트 `compose.yaml` 추가 — `docker compose --profile dev up -d`로 Postgres+API+Web 한 번에 기동
 - cleanup: 자동기동 스크립트(`scripts/auto-up.sh`), direnv(`.envrc`), git hooks(`.githooks/post-merge`, `post-checkout`) 제거 — 단일 Compose 진입점으로 단순화
 - ops(compose): dev 프로필/127.0.0.1 바인딩 확정, README 예시 정리
 - Makefile: 탭 인덴트 수정(info-venv, seed-data, ghcr-login, dev-containers)로 `make` 레시피 파싱 오류 해결

### 웹: 디자인 톤 전환(피그마 기준 1차)
- 헤더를 미니멀(로고+타이틀+햄버거)로 교체: `components/figma-header.tsx`, `components/header-gate.tsx`
- 홈을 "히어로(풀블리드) → 6개 메뉴"로 단순화: `app/page.tsx`
- CSS: `full-bleed` 유틸 추가, 히어로 풀블리드/캡션 바, 프리뷰용 클래스는 유지

### CI: 배포 워크플로 클린업 단계 수정
- 원인: SSH cleanup 단계에서 `IMAGE_PREFIX` 미전달 + heredoc 단일 인용으로 로컬 확장 차단 → set -u에서 실패
- 조치: `ssh ... env IMAGE_PREFIX=... KEEP_IMAGES=... bash -s << 'EOF'`로 원격 환경에 명시 전달, 상단에 `: "${IMAGE_PREFIX:?...}"` 가드 추가
- 추가: deploy ssh 스텝에도 `IMAGE_PREFIX` 존재 가드 삽입

### 네이밍 통일(segecon→sogecon)
- compose 프로젝트명: `sogecon-local-dev`
- 네트워크 예시: `sogecon_net` (문서/예시, guard 스크립트 포함)
- 임시 도메인 예시: `sogecon.wastelite.kr`, `api.sogecon.wastelite.kr`
### OPS 기본 경로 통일
- 업로드 기본 경로: `/var/lib/sogecon/uploads` (cloud-start.sh)

### Dev compose 정리
- infra의 dev/test compose 삭제. 루트 `compose.yaml` dev 프로필에서 dev DB(5433)와 test DB(5434)를 함께 기동하도록 통일

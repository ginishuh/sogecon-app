## 2025-11-03

### PG-only 전환 & 네트워크 옵션
- 정책: 데이터베이스 백엔드를 PostgreSQL로 전면 통일. SQLite 경로/예시 제거.
- API 설정: `apps/api/config.py`에 `postgresql+psycopg://` 강제 검증 추가, 기본값 dev PG(5433).
- Alembic: 기본 URL을 PG(5433)로 변경(`apps/api/alembic.ini`).
- DB 헬퍼: SQLite 분기 제거(`apps/api/db.py`).
- 테스트: `tests/api/conftest.py` PG 전용화, 기본 `localhost:5434/appdb_test` 사용.
- 배포: `ops/cloud-migrate.sh` `DOCKER_NETWORK` 지원, `scripts/deploy-vps.sh --network` 추가.
- CI 배포: `.github/workflows/deploy.yml`이 `vars.DOCKER_NETWORK`를 읽어 원격 네트워크 생성/전달.
- 문서: README, `.env*.example`, 런북(한/영), 가이드(AGENTS/COPILOT/CLAUDE), `docs/architecture.md`, `ops/deploy_api.md`를 “PostgreSQL만 지원”으로 통일. Alembic 네트워크 사용 예시 추가.

### 웹 CSP 강화 (#40)
- Next.js 미들웨어에서 요청별 nonce를 생성해 `Content-Security-Policy`에 `'nonce-…'`를 주입.
- App Router 레이아웃이 nonce 헤더를 읽어 Analytics 스크립트에 전달하도록 수정.
- Relax 환경(`NEXT_PUBLIC_RELAX_CSP=1`/비프로덕션)에서는 기존 완화 지시어 유지, 운영에서는 `'unsafe-inline'` 제거.

문서
- README, `docs/security_hardening.md`에 nonce 기반 CSP 운용 지침 정리.

테스트
- `pnpm -C apps/web test` (환경변수: `PNPM_IGNORE_NODE_ENGINE=1 PNPM_ENGINE_STRICT=false npm_config_engine_strict=false`) ✅
- `pnpm -C apps/web exec vitest run __tests__/csp.test.ts __tests__/middleware.test.ts` ✅
- Vitest 환경에서 `next/image` 모킹 시 DOM 미지원 속성(priority 등)을 제거해 JSDOM 경고 방지
- `generateNonce` 유틸을 분리하고 단위 테스트 추가, `style-src 'unsafe-inline'` 유지 근거를 README/security_hardening에 명시
- `pnpm -C apps/web build` ✅ (엔진 강제 옵션 포함)
- `.github/workflows/create-waiver-issue.yml` 개선 — push(main) 트리거 + noop job 추가, dispatch에서만 이슈 생성 로직 실행
- `.github/workflows/deploy.yml`에서 GHCR_PAT 미설정 시 선행 검증, SSH 원격 스크립트에 env를 안전 전송(printf %q), 서비스 루트 경로 `/srv/sogecon-app` 반영

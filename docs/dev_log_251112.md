# 개발 로그 2025-11-12

## 동문수첩 및 게시판 UI 리디자인

### 1. 동문수첩 필터 UI 개선

**요구사항**:
- 동문수첩 필터가 너무 많아서 모바일에서 복잡함
- 기본적으로 기수 + 검색어만 표시하고, 상세 검색은 별도 버튼으로 분리
- PC 웹에서는 전체 표시 가능

**변경 사항**:
- 기본 필터 (항상 표시): 검색어 + 기수 + 정렬
- 상세 검색 (토글): 전공, 회사, 업종, 지역, 직함 + 필터 초기화
- 모바일: "상세 검색" 버튼으로 펼치기/접기 (기본 접힘)
- 데스크톱 (md 이상): 모든 필터 항상 표시
- Accordion 제거하여 UI 단순화
- 접근성: aria-label, aria-expanded 적용

**수정 파일**:
- `apps/web/app/directory/page.tsx`

### 2. 게시판 UI 리디자인 (Figma 기반)

**요구사항**:
- Figma 디자인 기반 카드 스타일로 변경
- 검색 기능, 글쓰기 기능, 게시물 번호 표시
- 모바일 친화적인 UI

**변경 사항**:
- 테이블 → 카드 리스트 레이아웃
  - 각 게시물을 카드 형태로 표시
  - 카테고리 배지 (빨간색, bg-red-600)
  - 제목, 작성자, 날짜, 조회수, 댓글 수 표시
  - 호버 효과 (hover:bg-slate-50)
- FAB 글쓰기 버튼 (오른쪽 하단 고정)
  - fixed bottom-6 right-6 z-50
  - 빨간색 원형 버튼 (bg-red-600)
  - + 아이콘 (SVG)
  - 그림자 효과 (shadow-lg)
- 검색창 개선 (rounded-full)
  - 배경: bg-slate-50
  - 포커스 시 흰색 배경으로 변경
  - 초기화 버튼 추가
- "더 불러오기" 버튼 스타일 페이지네이션
- 조회수/댓글 수: 더미 데이터로 표시 (백엔드 추가 예정)

**수정 파일**:
- `apps/web/app/board/page.tsx`

### 3. Schema 생성 스크립트 수정

**문제**:
- pre-push hook에서 `ModuleNotFoundError: No module named 'itsdangerous'` 발생
- system Python을 사용하여 .venv 패키지에 접근 불가

**해결**:
- `packages/schemas/package.json` — `python` → `../../.venv/bin/python`
- .venv의 Python을 명시적으로 사용하도록 수정

**검증**:
- ✅ TypeScript 타입 체크 통과
- ✅ ESLint 통과
- ✅ 반응형 레이아웃 (모바일/데스크톱)

### 4. 조회수 및 댓글 수 기능 구현

**백엔드 변경**:
- Post 모델에 `view_count` 컬럼 추가 (Integer, default=0)
- PostBase/PostRead 스키마에 `view_count`, `comment_count` 추가
- Alembic 마이그레이션 생성 및 적용 (b0defb6bab2f)
- `increment_view_count(db, post_id)` — 게시물 조회수 증가
- `get_comment_count(db, post_id)` — 게시물 댓글 수 조회
- 게시물 상세 조회 시 조회수 자동 증가
- 게시물 목록/상세 API에서 댓글 수 반환

**프론트엔드 변경**:
- Post 타입에 `view_count`, `comment_count` 추가
- 더미 데이터 (Math.random()) 제거
- 실제 API 응답 데이터 사용

**검증**:
- ✅ Pyright 타입 체크 통과 (0 errors)
- ✅ TypeScript 타입 체크 통과
- ✅ OpenAPI 스키마 재생성
- ✅ Alembic 마이그레이션 적용 완료

---

## Next.js 15 params 타입 되돌림 (CI 빌드 에러 수정)

**문제**:
- CI 빌드 실패: `Type '{ id: string; }' is missing the following properties from type 'Promise<any>'`
- 코드 리뷰에서 params를 동기 객체로 변경했으나, Next.js 15.5.4에서는 실제로 Promise 타입

**원인**:
- 리뷰 지적이 Next.js 14 기준이었음
- Next.js 15부터 params는 `Promise<{ id: string }>` 타입으로 변경됨

**해결**:
- `params: Promise<{ id: string }>` 복원
- `const { id: rawId } = await params;` 재적용

**수정 파일**:
- `apps/web/app/board/[id]/page.tsx:13-18`

**검증**:
- ✅ `pnpm -C apps/web exec tsc --noEmit` 통과

---

## 코드 리뷰 반영 (Must Fix + 권장 개선)

### Must Fix 1: 관리자 실패 분기 버그 수정

**문제**:
- 로그인된 일반 회원이 게시글/댓글 작성 시 403 Forbidden을 받으면 회원 플로우로 폴백하지 못함
- 401(UNAUTHORIZED)만 허용하여 403(FORBIDDEN)은 즉시 에러 발생

**원인**:
- `if exc_admin.status_code != HTTPStatus.UNAUTHORIZED:` 조건으로 401만 폴백 허용
- 로그인은 되어있지만 관리자가 아닌 경우 403이 발생하는데, 이를 회원으로 처리하지 못함

**해결**:
- 401과 403 모두 회원 플로우로 폴백하도록 수정
- `if exc_admin.status_code not in (HTTPStatus.UNAUTHORIZED, HTTPStatus.FORBIDDEN):`

**수정 파일**:
- `apps/api/routers/posts.py:103`
- `apps/api/routers/comments.py:45, 78`

### Must Fix 2: Next.js 페이지 파라미터 타입 오류

**문제**:
- `params: Promise<{ id: string }>` 타입 선언 및 `await params` 사용
- Next.js App Router는 params를 동기 객체로 전달하므로 타입 불일치

**해결**:
- `params: { id: string }`로 타입 수정
- `const { id: rawId } = params;` (await 제거)

**수정 파일**:
- `apps/web/app/board/[id]/page.tsx:13-18`

### 권장 개선 1: API 클라이언트 Accept 헤더 추가

**이유**:
- 일부 프록시/보안장비가 Accept 헤더 누락 시 호환성 문제 발생 가능
- 명시적으로 JSON 응답을 요청하여 안정성 향상

**변경**:
- `apps/web/lib/api.ts:84` — `Accept: 'application/json'` 헤더 추가

### 권장 개선 2: 날짜 포맷 Intl.DateTimeFormat 적용

**이유**:
- `toLocaleDateString`/`toLocaleString`은 런타임 로케일/타임존에 영향받음
- 서버(SSR)와 브라우저(CSR) 간 타임존 불일치 가능성

**변경**:
- `Intl.DateTimeFormat` 사용, `timeZone: 'Asia/Seoul'` 명시
- 포맷터를 상수로 선언하여 재사용 (성능 개선)

**수정 파일**:
- `apps/web/lib/date-utils.ts`

### 검증 결과
- ✅ Python: ruff check, pyright (0 errors)
- ✅ Web: tsc --noEmit (타입 체크 통과)
- ✅ 로컬 Node 버전 불일치는 CI에서 해결됨

## CI 실패 수정 (이전 작업)

### 문제
- PR #50의 Python CI job이 Bandit B101 경고로 실패
- `apps/api/routers/comments.py`의 51번, 78번 줄에서 `assert member.id is not None` 사용

### 원인
- Python의 assert 문은 최적화 모드(`-O` 플래그)로 실행할 때 제거됨
- Production 환경에서 안전하지 않은 코드 패턴
- Bandit B101 규칙 위반

### 해결
- assert 문을 명시적인 None 체크로 변경:
  ```python
  if member.id is None:
      raise HTTPException(
          status_code=500, detail="Member ID is None"
      ) from None
  ```
- 추가로 해결한 규칙:
  - B904: except 블록 내에서 `raise ... from None` 사용
  - E501: 라인 길이 88자 제한 준수

### 검증
- Bandit: No issues identified
- Pyright: 0 errors, 0 warnings
- Ruff: All checks passed

### 관련 파일
- `apps/api/routers/comments.py`: assert 제거 및 명시적 체크로 변경
- `docs/worklog.md`: 작업 내용 기록

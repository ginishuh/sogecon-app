# 개발 로그 2025-11-12

## 코드 리뷰 반영 (Must Fix + 권장 개선)

### Must Fix 1: 관리자 실패 분기 버그 수정

**문제**:
- 로그인된 일반 회원이 게시글/댓글 작성 시 403 Forbidden을 받으면 회원 플로우로 폴백하지 못함
- 401(UNAUTHORIZED)만 허용하여 403(FORBIDDEN)은 즉시 에러 발생

**원인**:
- `if exc_admin.status_code != HTTPStatus.UNAUTHORIZED:` 조건으로 401만 폴백 허용
- 로그인은 되어있지만 관리자가 아닌 경우 403이 발생하는데, 이를 회원으로 처리하지 못함

**해결**:
- 401과 403 모두 회원 플로우로 폴백하도록 수정
- `if exc_admin.status_code not in (HTTPStatus.UNAUTHORIZED, HTTPStatus.FORBIDDEN):`

**수정 파일**:
- `apps/api/routers/posts.py:103`
- `apps/api/routers/comments.py:45, 78`

### Must Fix 2: Next.js 페이지 파라미터 타입 오류

**문제**:
- `params: Promise<{ id: string }>` 타입 선언 및 `await params` 사용
- Next.js App Router는 params를 동기 객체로 전달하므로 타입 불일치

**해결**:
- `params: { id: string }`로 타입 수정
- `const { id: rawId } = params;` (await 제거)

**수정 파일**:
- `apps/web/app/board/[id]/page.tsx:13-18`

### 권장 개선 1: API 클라이언트 Accept 헤더 추가

**이유**:
- 일부 프록시/보안장비가 Accept 헤더 누락 시 호환성 문제 발생 가능
- 명시적으로 JSON 응답을 요청하여 안정성 향상

**변경**:
- `apps/web/lib/api.ts:84` — `Accept: 'application/json'` 헤더 추가

### 권장 개선 2: 날짜 포맷 Intl.DateTimeFormat 적용

**이유**:
- `toLocaleDateString`/`toLocaleString`은 런타임 로케일/타임존에 영향받음
- 서버(SSR)와 브라우저(CSR) 간 타임존 불일치 가능성

**변경**:
- `Intl.DateTimeFormat` 사용, `timeZone: 'Asia/Seoul'` 명시
- 포맷터를 상수로 선언하여 재사용 (성능 개선)

**수정 파일**:
- `apps/web/lib/date-utils.ts`

### 검증 결과
- ✅ Python: ruff check, pyright (0 errors)
- ✅ Web: tsc --noEmit (타입 체크 통과)
- ✅ 로컬 Node 버전 불일치는 CI에서 해결됨

## CI 실패 수정 (이전 작업)

### 문제
- PR #50의 Python CI job이 Bandit B101 경고로 실패
- `apps/api/routers/comments.py`의 51번, 78번 줄에서 `assert member.id is not None` 사용

### 원인
- Python의 assert 문은 최적화 모드(`-O` 플래그)로 실행할 때 제거됨
- Production 환경에서 안전하지 않은 코드 패턴
- Bandit B101 규칙 위반

### 해결
- assert 문을 명시적인 None 체크로 변경:
  ```python
  if member.id is None:
      raise HTTPException(
          status_code=500, detail="Member ID is None"
      ) from None
  ```
- 추가로 해결한 규칙:
  - B904: except 블록 내에서 `raise ... from None` 사용
  - E501: 라인 길이 88자 제한 준수

### 검증
- Bandit: No issues identified
- Pyright: 0 errors, 0 warnings
- Ruff: All checks passed

### 관련 파일
- `apps/api/routers/comments.py`: assert 제거 및 명시적 체크로 변경
- `docs/worklog.md`: 작업 내용 기록

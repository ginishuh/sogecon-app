# 계획서 — 2025-10-07 (M3 완료 + 다음 단계)

## 배경 / SSOT 정합성
- 본 계획은 프로젝트 SSOT인 `docs/Project_overview.md`(IA/목적)와 현재 코드 상태를 기준으로, M3 잔여 과제와 A/B/C 영역의 1차 도달 목표를 정의합니다.
- 현재 정합성: 인증·행사·알림(푸시) 1차 완성, 수첩/소개/내정보/활성화/문의는 후속 필요.

## 목표(이번 사이클)
1) M3-4 마감 — Web Push 보강(암호화/정리/지표) 안정화 및 문서화 — 완료(PR #7)
2) A-2/A-3/A-4 최소기능 제공 — 회원활성화/비번변경/관리자 문의
3) B “내 정보” 1차 — 표시용 생일(양/음) 포함, 공개범위 토글
4) C 수첩 스켈레톤 — 목록/검색/필터 프레임 + 상세 뼈대

## 현재 상태(2025-10-08 기준)
- PR #7 병합(607d59b): Web Push M3-4 납품
  - at-rest 암호화(AES-GCM) 옵션, `endpoint_hash` 조회/삭제, NOT NULL 제약(0009)
  - 잘못된 KEK(키 미스매치) 시 안전 실패 처리(`decrypt_str` 예외 방지)
  - 관리자 테스트 발송 1/min 레이트리밋 + 429 테스트
  - prune-logs 엔드포인트 + 테스트, Admin UI에 암호화 ON/OFF 표시
  - cryptography 44.0.1로 상향(pip-audit 경고 해소)
  - schemas 생성물(pacakges/schemas) 커밋 및 CI 가드 제외 처리
  - 테스트 25개 통과, CI 그린

- A/B/C Phase 1 납품: 활성화/비번변경/문의(A-2/3/4), 내 정보 v1(B), 수첩 v0(C)
  - API: `/auth/member/activate`, `/auth/member/change-password`, `/support/contact`, `/me` GET/PUT, `/members` 필터/카운트
  - Web: `/activate`, `/settings/password`, `/support/contact`, `/me`, `/directory` 화면 연결
  - Tests: 총 35개 통과(권한/검증/레이트리밋 포함)

## 산출물(DoD)
- M3-4(완료)
  - [x] at-rest 암호화 옵션(AES-GCM), `endpoint_hash` 조회/삭제, 통계 `encryption_enabled`
  - [x] `endpoint_hash` NOT NULL 전환 및 백필(0009)
  - [x] 잘못된 KEK 시 안전 실패(`decrypt_str` try/except)
  - [x] 관리자 `prune-logs` + 테스트(25 passed)
  - [x] 문서 보강(`pwa_push.md`, `security_hardening.md`, `architecture.md`)
- A-2/3/4
  - [x] 회원활성화 `/auth/member/activate`(서명 토큰 검증) + 비밀번호 즉시 설정
  - [x] 비밀번호 변경 `/auth/member/change-password`
  - [x] 관리자 문의 `/support/contact`(파일 아웃박스/레이트리밋/스팸 가드)
  - [x] 테스트(성공/실패/레이트리밋)
- B 내 정보 v1
  - [x] `/me` 상세 조회/수정(표시용 생일/음력/연락처/공개범위 토글)
  - [x] 프런트 편집 화면 + 성공/검증 에러 UX
  - [x] 테스트(권한/검증)
- C 수첩 v0
  - [x] 목록/검색/필터(기수/업종/전공/지역) 프레임, 무한스크롤 스텁
  - [x] 상세 뼈대(연락 링크는 정책에 따라 비활성/표시)
  - [x] 테스트(200/필터 쿼리 검증)

## 작업 순서(브랜치/PR)
1) (완료) feat/m3-webpush-crypto (#7) — 병합됨
2) (완료) feat/a2-a3-a4-auth-support — 활성화/비번변경/문의
   - API
     - A-2: `POST /auth/member/activate` (학번/토큰 검증 → MemberAuth 생성/갱신, 즉시 비밀번호 설정)
       - 토큰 저장소: 단순 DB 테이블 또는 서명 값(itsdangerous) — dev 단계에선 파일/DB로 대체
       - 레이트리밋 5/min/IP, 실패 시 401/422 구분
     - A-3: `POST /auth/member/change-password` (CurrentMember, 기존 비번 확인 → 교체)
     - A-4: `POST /support/contact` (제목/본문/연락처, 파일 아웃박스/로그 기록, 레이트리밋)
   - Web
     - /activate (토큰 수령) · /settings/password · /support/contact 페이지
     - 성공/실패 토스트, 폼 검증, 401/429 처리
   - Tests(추가 목표: +5 이상 → 총 30+)
     - 활성화 성공/만료/위조, 비번변경 성공/실패, 문의 429/검증
3) (완료) feat/b-profile-v1 — “내 정보” 1차 편집
   - API: `/me` 조회/수정(표시용 생일(양/음), 연락처, 공개범위 토글)
   - Web: 프로필 편집 화면, 검증/저장 UX
   - Tests: 권한(401/403), 필드 검증(422)
4) (완료) feat/c-directory-skeleton — 수첩 스켈레톤
   - 목록/검색/필터(기수/업종/전공/지역), 상세 뼈대, 테스트 200·필터 쿼리 동작

## 위험/의존성
- 학번 기반 인증(SSOT) ↔ 현재 이메일 기반 멤버 인증: 활성화 흐름에서 학번→이메일 매핑 정책 필요
- 메일 발송 인프라(문의/활성화 토큰): 개발 단계에선 콘솔/파일 아웃박스로 대체
- 개인정보/공개범위 정책: B 영역 설계 시 SSOT와 정책 합의 필요

## 측정/검증
- 테스트 수: 25(현재) → 30+(A/B/C 추가)
- 빌드/린트/타입 검사 CI 그린
- 문서: 변경 반영(`architecture.md` 정합성 표 유지)

## 일정(권고)
- A-2/A-3/A-4: 1~2일(동시 진행 가능) → 단일 PR 시작, 필요 시 분할
- B v1: 1~2일
- C v0: 1~2일

## 메모(SSOT 정합성)
- `docs/Project_overview.md`에 반영된 IA/목적과 현재 라우트/화면 매핑 표는 유지·보완 중
- 활성화 플로우(학번→이메일 매핑) 정책 합의 시 문서 우선 업데이트 후 구현 반영

---

## 다음 단계(After Merge Plan)
- (완료) M3 Push Polish — Web Push 운영 마감(문서/테스트/UI 보강)
  - 참조: `docs/m3_push_polish_plan_251007.md`
- B v2 — 프로필 확장/검증 강화
  - 연락처·주소·직함 필드 검증 규칙(정규식/길이) 명시 및 테스트
  - 공개범위 정책 문서화 + UI 힌트/경고 카피 정리
  - 아바타 업로드(선택) 및 리사이즈/보안 가드
- C v1 — 디렉터리 UX 고도화
  - 필터 상태 URL 동기화/공유, 페이징·무한스크롤 안정화
  - 카드 디자인/접근성 개선, 공개범위에 따른 연락 액션 제어
- M4 — 운영화/안정성(SSOT: `docs/execution_plan_251006.md`)
  - 배포 파이프라인(빌드/런), 관측(구조화 로그·성공률), 보안(CSP·레이트리밋 분리)
  - DTO 동기화 자동화(`packages/schemas` → 웹 타입 연동), PWA 오프라인 스켈레톤
